Link PlantUML
//www.plantuml.com/plantuml/dpng/vPZFRkCs4CRlUefvWKsHFy020RBOR7VJNGG5ZBYjpvGraWZJb45ICU2NwINFq9DlUh4EBOrfsf9JPxszh844ilJDy9lvaIRjZzO9u-gvIiJKLGR62uaA3GWBesH1Z-HKBeHsC6dM9aSLtNjgNkeKJNmFhQrgCqNzZ6OfbAjruRCz_RKdAr0jqSmspoRTwBzBPxs1E6ThYWRFaiH9fx2ziQeB-5KuePFaxWukBzYYXfmkuAaghQlo78qppKk1S7UN92Duzu5rS1iY_FZoMJY4KRZaabd_Zc975FN559XgQI53inK5rGUgzR-eGh63wWmFp2H2RM4W1zt1-oG1Uldw60jbvIj2OT6jK4EGXQwIy3TSDcjjfwKZzGFT-_OPcZM5pgLpg7G8Ysq_4YK4wx1KkDl57P3XqZVGTv33_02-0jIRxAgg5l3WqGd5Z2c87C0SIt_NmlijrfbFqVcYrwuj9d2V5YB5JKU_DYygT-rrb84xWZeBtOxyexBuch-nn4pLklXbx4JcGDGv5BXi8JcSRpeQh9AvRYP5LW1DAKYkjqAsGn5Hy2w4eIJ0iwTB4ChqVtx5N5t0Lw4pgczH2hjP7zN23O1kbI1qAj4DeTxdq5LvhzsoCfksS9xMpUOVZRdDFblXmaaqhdtURuNh3HDeU1wCXlJSZNuVQO4AIzqsOwYgr4i8EcHekPC3SoZgVTVbQCIvxF_atEXOUtDx2N-8cbOfLAL6YisfaiD9metZTN03XK8vBN6d5GVIJZiHfO99hMaGqucJf7i-eUSZqwnpCcO9PbwP38rtkMDY4cMccAvV8P8_jP98ATIs6KMpLaw6siFKvsJ1OPZvyNIFWWaCSl9Q3wOFNX-m96npL1d9R-5FZa73QQBHGitCkUywOdaTM7hszFPTYxCVuVKXma7mnsd2CCqEvbjOmi_CyYfcELxWIWfL7i5v5J02Ieq6xes30WlKS0afAecfz6_U3FaroZ_TYZq9ShnHNb_09r7lRfB-VGVNl-EZG2ayH5qN0Mzx5Xqx8vg_CThKuWFOez0EOTcyn0Ufe3aPw76Idfwl8aOtP8yhp8L9CP86KNoYv9AXFNSc0mlX4wv4Mt66FJL7qy6x3NFXz7b0yGDBFQ9-0jNkr7S4gp_u7QNAWMTbsxr-D6Ak7rA_6k1jZ07EJlcyaFs9FXb47Bh0c7iex_BZSb-5VYBe-zgc_mVhLGty9SSF-DQbtSaZzbp3T-3d56UT0b-qMyhfp9Tlsuqholr3S3vIACCSwF2XBvY9UlWhGTYE-sBZpHXUWHfpysQ_YvfFS9nPl2FVN7JKD3nN-h0OpViqivqt_qnBrnwsUlfcssG9T_z9EeTcyopYU_odbUFRmBVFh3Z73odzlwCCVFqCfrOcvejyg8ppHpAgzR3Is7vGMinpd3aGUaamKE_b74ii5hMUxMTanq40IsaoA73bFpLTM9LxFyICaezqfvwhVm40
@startuml
actor Spieler as P
participant Würfel
participant Räuber
participant Ressourcenverwaltung as RV
participant Regelwerk as RW
actor Mitspieler
participant Spielfeld

title Spielzug Catan

== 1. Würfeln für Rohstofferträge ==

P -> Würfel : Würfeln 
activate P
activate Würfel
Würfel --> P : Ergebnis der Würfel

Würfel -> RV : Ergebnis der Würfel

Würfel -> Mitspieler : Ergebnis der Würfel

deactivate Würfel

alt Würfelergebnis = 7

    P -> Räuber : Räuber versetzen 

    P -> Spielfeld : Gewünschter FeldID übermitteln

    P -> Mitspieler : Karte stehlen 
activate Mitspieler
Mitspieler -->> P : Karte übergeben
    loop Für alle Spieler mit mehr als 7 Rohstoffkarten

        Mitspieler -> RV : Abgabe der Hälfte der Rohstoffkarten 

    end
deactivate Mitspieler
else
    loop Für alle Spieler mit Siedlung/Stadt auf gewürfeltem Feld

        RV --> P : Rohstoffkarte erhalten
        activate RV
        RV -> Mitspieler: Rohstoffkarte erhalten 

deactivate RV

    end
end

== 2. Handelsphase ==
opt
    P -> Mitspieler : Handel anbieten 
activate Mitspieler
    Mitspieler --> P : Antwort auf Handel 

    
    opt Handel akzeptiert

        P -> Mitspieler : Rohstoffe übergeben

        Mitspieler -> P : Rohstoffe übergeben

    end
    
    opt Handel abgelehnt
        Mitspieler --> P : Ablehnung des Handels
deactivate Mitspieler

    end
end

opt
    opt Handel mit Ressourcenverwaltung
        opt 4:1 Tausch ohne Hafen
activate RV
            P -> RV : 4 gleiche Rohstoffe 
            P ->> RV : Wahl Wunschrohstoff

P ->> RW : Prüfungsaufforderung

activate RW
            RW --> P : Prüfungsergebnis

            alt Handel gültig
                RV --> P : Wunschrohstoffkarte
deactivate RV
            else Handel ungültig
                RW --> P : Fehlermeldung: Ungültiger Handel 
deactivate RW
            end
        end
        
        opt 3:1 Tausch mit 3:1-Hafen
            P -> RV : 3 gleiche Rohstoffe
activate RV
            P ->> RV : Wahl Wunschrohstoff 
P ->> RW : Prüfungsauffoderung
activate RW
            RW --> P : Prüfungsergebnis 
            alt Handel gültig
                RV --> P : Wunschrohstoffkarte
deactivate RV
            else Handel ungültig
                RW --> P : Fehlermeldung: Ungültiger Handel 
deactivate RW
            end
        end
        
        opt 2:1 Tausch mit Spezialhafen
            P -> RV : 2 Rohstoffe einer Art gegen 1 beliebigen 
activate RV
            P ->> RV : Wahl Wunschrohstoff 

P ->> RW : Prüfungsauffoderung
activate RW
            RW --> P : Prüfungsergebnis

            alt Handel gültig
                RV --> P : Wunschrohstoffkarte
deactivate RV
            else Handel ungültig
                RW --> P : Fehlermeldung: Ungültiger Handel
deactivate RW
            end
        end
    end
end

== 3. Bauphase ==
opt Bauen
    opt Spieler hat genug Rohstoffe für Straße
        P ->> Spielfeld : Kante wählen 
activate Spielfeld
P ->> RW : Prüfungsauffoderung
activate RW
     RW --> P : Prüfungsergebnis
 alt Bau gültig
            P ->> Spielfeld : Spielerfarbe
            Spielfeld -> Spielfeld : Straße setzen

            P -> RV : Bezahlen 
deactivate Spielfeld
        else Bau ungültig
            RW --> P : Fehlermeldung: Ungültiger Bau 
deactivate RW
        end
    end

    opt Spieler hat genug Rohstoffe für Siedlung
        P ->> Spielfeld : Feld wählen 
activate Spielfeld
      P ->> RW : Prüfungsauffoderung
activate RW
     RW --> P : Prüfungsergebnis
        alt Bau gültig
            P ->> Spielfeld : Spielerfarbe
            Spielfeld -> Spielfeld : Siedlung bauen 

            P -> RV : Bezahlen 
deactivate Spielfeld  
        else Bau ungültig
            RW --> P : Fehlermeldung: Ungültiger Bau
deactivate RW
        end
    end

    opt Spieler hat genug Rohstoffe für Stadt

        P ->> Spielfeld : Siedlung wählen
activate Spielfeld
activate RW 
        P ->> RW : Prüfungsauffoderung
     RW --> P : Prüfungsergebnis
        alt Ausbau gültig
            P ->> Spielfeld : Spielerfarbe
            Spielfeld -> Spielfeld : Siedlung zu Stadt ausbauen

            P -> RV : Bezahlen 
deactivate Spielfeld       
        else Ausbau ungültig
            RW --> P : Fehlermeldung: Ungültiger Ausbau 
deactivate RW
        end
    end

    opt Spieler hat genug Rohstoffe für Entwicklungskarte
activate RW
        P ->> RW : Prüfungsauffoderung
     RW --> P : Prüfungsergebnis
        alt Kauf gültig

            P -> RV : Entwicklungskarte kaufen
activate RV
            RV --> P : Entwicklungskarte
deactivate RV 
            P -> RV : Bezahlen
        else Kauf ungültig
            RW --> P : Fehlermeldung: Ungültiger Kauf 
deactivate RW
        end
    end
end

== 4. Spielen von Entwicklungskarten ==
opt Spieler möchte eine Entwicklungskarte spielen
    alt Ritterkarte
        P -> Räuber : Räuber versetzen 
        P ->> Spielfeld : FeldID 
        P -> Mitspieler : Karte stehlen 
activate Mitspieler
Mitspieler --> P : Karte übergeben
deactivate Mitspieler
        
    else alt Fortschrittkarte
        P -> Spielfeld : Fortschrittseffekt anwenden 
    else alt Siegpunktkarte
        P --> P : Siegpunkt wird gezählt
    end

end
deactivate P
@enduml